<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fruiting Chamber Calculator | Heartwood Mushrooms</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <style>
        :root {
            --brown-dark: #3b281e;
            --brown-medium: #5a4235;
            --tan: #d9bf90;
            --cream: #e7ded1;
            --cream-light: #f5f1eb;
            --forest-green: #455a30;
            --forest-green-light: #5a7a3d;
            --blue-accent: #545da3;
            --white: #ffffff;
            --shadow: rgba(59, 40, 30, 0.1);
            --shadow-strong: rgba(59, 40, 30, 0.2);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: linear-gradient(135deg, var(--cream-light) 0%, var(--cream) 100%);
            min-height: 100vh;
            color: var(--brown-dark);
            line-height: 1.6;
        }

        .container { max-width: 900px; margin: 0 auto; padding: 2rem 1rem; }

        header { text-align: center; margin-bottom: 2rem; }
        h1 { font-size: 2rem; font-weight: 700; color: var(--brown-dark); margin-bottom: 0.5rem; }
        .subtitle { color: var(--brown-medium); font-size: 1.1rem; }

        .calculator-card {
            background: var(--white);
            border-radius: 16px;
            box-shadow: 0 4px 24px var(--shadow), 0 1px 4px var(--shadow);
            overflow: hidden;
        }

        .input-section { padding: 2rem; background: var(--white); }
        .input-group { margin-bottom: 1.5rem; }
        .input-group:last-child { margin-bottom: 0; }

        label { display: block; font-weight: 600; margin-bottom: 0.5rem; color: var(--brown-dark); }
        .input-hint { font-size: 0.85rem; color: var(--brown-medium); margin-bottom: 0.5rem; }

        .slider-container { position: relative; padding: 0.5rem 0; }

        input[type="range"] {
            -webkit-appearance: none;
            width: 100%;
            height: 8px;
            border-radius: 4px;
            background: linear-gradient(to right, var(--tan) 0%, var(--forest-green) 100%);
            outline: none;
            cursor: pointer;
        }

        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 24px; height: 24px;
            border-radius: 50%;
            background: var(--brown-dark);
            cursor: pointer;
            border: 3px solid var(--white);
            box-shadow: 0 2px 8px var(--shadow-strong);
            transition: transform 0.15s ease;
        }

        input[type="range"]::-webkit-slider-thumb:hover { transform: scale(1.1); }

        input[type="range"]::-moz-range-thumb {
            width: 24px; height: 24px;
            border-radius: 50%;
            background: var(--brown-dark);
            cursor: pointer;
            border: 3px solid var(--white);
            box-shadow: 0 2px 8px var(--shadow-strong);
        }

        .slider-value { text-align: center; font-size: 2.5rem; font-weight: 700; color: var(--forest-green); margin: 0.5rem 0; }
        .slider-value span { font-size: 1rem; color: var(--brown-medium); font-weight: 400; }

        .slider-labels { display: flex; justify-content: space-between; font-size: 0.8rem; color: var(--brown-medium); margin-top: 0.25rem; }

        .size-toggle { display: flex; gap: 1rem; margin-top: 0.5rem; }

        .size-btn {
            flex: 1; padding: 1rem;
            border: 2px solid var(--tan);
            border-radius: 12px;
            background: var(--white);
            cursor: pointer;
            transition: all 0.2s ease;
            text-align: center;
        }

        .size-btn:hover { border-color: var(--forest-green); background: var(--cream-light); }
        .size-btn.active { border-color: var(--forest-green); background: linear-gradient(135deg, rgba(69, 90, 48, 0.08) 0%, rgba(69, 90, 48, 0.04) 100%); }
        .size-btn .size-title { font-weight: 700; font-size: 1.1rem; color: var(--brown-dark); }
        .size-btn .size-desc { font-size: 0.85rem; color: var(--brown-medium); margin-top: 0.25rem; }
        .size-btn.active .size-title { color: var(--forest-green); }

        /* 3D Visualization */
        .viz-section { padding: 1.5rem 2rem; background: var(--cream-light); border-top: 1px solid var(--cream); }
        .viz-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; }
        .viz-header h3 { font-size: 1rem; font-weight: 600; color: var(--brown-dark); }
        .viz-stats { font-size: 0.85rem; color: var(--brown-medium); }

        #viz-container {
            width: 100%; height: 350px;
            border-radius: 12px;
            overflow: hidden;
            cursor: grab;
            background: linear-gradient(135deg, #2a3a1f 0%, #1a2612 100%);
        }
        #viz-container:active { cursor: grabbing; }

        .viz-legend { display: flex; gap: 1.5rem; margin-top: 0.75rem; font-size: 0.8rem; color: var(--brown-medium); flex-wrap: wrap; }
        .viz-legend-item { display: flex; align-items: center; gap: 0.4rem; }
        .viz-legend-color { width: 12px; height: 12px; border-radius: 2px; }

        .results-section {
            background: linear-gradient(135deg, var(--brown-dark) 0%, var(--brown-medium) 100%);
            padding: 2rem;
            color: var(--white);
        }

        .results-header { text-align: center; margin-bottom: 1.5rem; }
        .results-header h2 { font-size: 1.3rem; font-weight: 600; color: var(--tan); margin-bottom: 0.25rem; }
        .results-header .target { font-size: 1.8rem; font-weight: 700; }
        .results-header .cycle-info { font-size: 0.95rem; color: var(--tan); margin-top: 0.5rem; }

        .results-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; }
        .result-card { background: rgba(255, 255, 255, 0.1); border-radius: 12px; padding: 1.25rem; backdrop-filter: blur(10px); }
        .result-card .label { font-size: 0.8rem; text-transform: uppercase; letter-spacing: 0.05em; color: var(--tan); margin-bottom: 0.5rem; }
        .result-card .value { font-size: 1.5rem; font-weight: 700; }
        .result-card .detail { font-size: 0.85rem; color: rgba(255, 255, 255, 0.7); margin-top: 0.25rem; }

        .spec-sheet { margin-top: 1.5rem; background: rgba(0, 0, 0, 0.2); border-radius: 12px; padding: 1.5rem; }
        .spec-sheet h3 { font-size: 1rem; color: var(--tan); margin-bottom: 1rem; text-transform: uppercase; letter-spacing: 0.05em; }

        .spec-list { font-family: 'SF Mono', 'Monaco', 'Consolas', monospace; font-size: 0.9rem; line-height: 1.8; }
        .spec-list .spec-row { display: flex; justify-content: space-between; border-bottom: 1px solid rgba(255, 255, 255, 0.1); padding: 0.5rem 0; }
        .spec-list .spec-row:last-child { border-bottom: none; }
        .spec-list .spec-label { color: rgba(255, 255, 255, 0.7); }
        .spec-list .spec-value { font-weight: 600; text-align: right; }

        .tip-box { margin-top: 1.5rem; background: rgba(69, 90, 48, 0.3); border-left: 4px solid var(--forest-green-light); border-radius: 0 8px 8px 0; padding: 1rem 1.25rem; }
        .tip-box .tip-title { font-weight: 600; color: var(--forest-green-light); margin-bottom: 0.25rem; font-size: 0.9rem; }
        .tip-box p { font-size: 0.9rem; color: rgba(255, 255, 255, 0.9); }

        .copy-btn {
            display: block; width: 100%; margin-top: 1.5rem; padding: 1rem;
            background: var(--tan); color: var(--brown-dark);
            border: none; border-radius: 8px;
            font-size: 1rem; font-weight: 600;
            cursor: pointer; transition: all 0.2s ease;
        }
        .copy-btn:hover { background: var(--cream); transform: translateY(-1px); }
        .copy-btn:active { transform: translateY(0); }

        footer { text-align: center; padding: 2rem 1rem; color: var(--brown-medium); font-size: 0.9rem; }
        footer a { color: var(--forest-green); text-decoration: none; }
        footer a:hover { text-decoration: underline; }

        @media (max-width: 600px) {
            .container { padding: 1rem; }
            h1 { font-size: 1.5rem; }
            .input-section, .results-section { padding: 1.5rem; }
            .slider-value { font-size: 2rem; }
            .size-toggle { flex-direction: column; }
            .results-grid { grid-template-columns: 1fr 1fr; }
            .result-card .value { font-size: 1.2rem; }
            #viz-container { height: 280px; }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>Fruiting Chamber Calculator</h1>
            <p class="subtitle">Size your batch setup from target yield</p>
        </header>

        <div class="calculator-card">
            <div class="input-section">
                <div class="input-group">
                    <label>Average Weekly Harvest</label>
                    <p class="input-hint">Target fresh mushroom yield (averaged across 4-week cycle)</p>
                    <div class="slider-container">
                        <input type="range" id="yield-slider" min="0.5" max="50" step="0.5" value="3">
                        <div class="slider-value"><span id="yield-value">3</span> <span>kg/week avg</span></div>
                        <div class="slider-labels">
                            <span>0.5 kg</span>
                            <span>50 kg</span>
                        </div>
                    </div>
                </div>

                <div class="input-group">
                    <label>Block Size</label>
                    <p class="input-hint">Master's mix supplemented block weight</p>
                    <div class="size-toggle">
                        <button class="size-btn active" data-size="5">
                            <div class="size-title">5 lb</div>
                            <div class="size-desc">2.3 kg · 6"×5"×10"</div>
                        </button>
                        <button class="size-btn" data-size="10">
                            <div class="size-title">10 lb</div>
                            <div class="size-desc">4.5 kg · 8"×6"×12"</div>
                        </button>
                    </div>
                </div>

                <div class="input-group">
                    <label>Biological Efficiency</label>
                    <p class="input-hint">BE% = Fresh Yield / (Block Weight × 40% dry fraction)</p>
                    <div class="slider-container">
                        <input type="range" id="be-slider" min="0" max="150" step="5" value="70">
                        <div class="slider-value"><span id="be-value">70</span><span>% BE</span></div>
                        <div class="slider-labels">
                            <span>0%</span>
                            <span>75%</span>
                            <span>150%</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 3D Visualization Section -->
            <div class="viz-section">
                <div class="viz-header">
                    <h3>Chamber Layout</h3>
                    <span class="viz-stats" id="viz-stats">Drag to rotate</span>
                </div>
                <div id="viz-container"></div>
                <div class="viz-legend">
                    <div class="viz-legend-item">
                        <div class="viz-legend-color" style="background: #d9bf90;"></div>
                        <span>Tent frame</span>
                    </div>
                    <div class="viz-legend-item">
                        <div class="viz-legend-color" style="background: #888;"></div>
                        <span>Wire shelving (18" deep)</span>
                    </div>
                    <div class="viz-legend-item">
                        <div class="viz-legend-color" style="background: #f5f5f5;"></div>
                        <span>Substrate blocks</span>
                    </div>
                </div>
            </div>

            <div class="results-section">
                <div class="results-header">
                    <h2>BATCH SETUP</h2>
                    <div class="target" id="target-display">3 kg/week avg</div>
                    <div class="cycle-info" id="cycle-info">~4 kg weeks 1-3, week 4 cleaning</div>
                </div>

                <div class="results-grid">
                    <div class="result-card">
                        <div class="label">Blocks per Batch</div>
                        <div class="value" id="blocks-value">19</div>
                        <div class="detail" id="blocks-detail">all in, all out</div>
                    </div>
                    <div class="result-card">
                        <div class="label">Chamber Size</div>
                        <div class="value" id="chamber-value">16 ft³</div>
                        <div class="detail" id="chamber-detail">2' × 2' × 4' tent</div>
                    </div>
                    <div class="result-card">
                        <div class="label">FAE Required</div>
                        <div class="value" id="fae-value">1.3 CFM</div>
                        <div class="detail" id="fae-detail">80mm fan on low</div>
                    </div>
                    <div class="result-card">
                        <div class="label">Fogger Size</div>
                        <div class="value" id="fogger-value">1-disc</div>
                        <div class="detail" id="fogger-detail">~7% duty cycle</div>
                    </div>
                </div>

                <div class="spec-sheet">
                    <h3>Full Spec Sheet</h3>
                    <div class="spec-list">
                        <div class="spec-row">
                            <span class="spec-label">Target (avg)</span>
                            <span class="spec-value" id="spec-target">3 kg/week</span>
                        </div>
                        <div class="spec-row">
                            <span class="spec-label">Production weeks</span>
                            <span class="spec-value" id="spec-prod-weeks">~4 kg/wk for 3 weeks</span>
                        </div>
                        <div class="spec-row">
                            <span class="spec-label">Block size</span>
                            <span class="spec-value" id="spec-block-size">5 lb (2.3 kg)</span>
                        </div>
                        <div class="spec-row">
                            <span class="spec-label">Biological efficiency</span>
                            <span class="spec-value" id="spec-be">70%</span>
                        </div>
                        <div class="spec-row">
                            <span class="spec-label">Yield per block</span>
                            <span class="spec-value" id="spec-yield-block">0.64 kg</span>
                        </div>
                        <div class="spec-row">
                            <span class="spec-label">Blocks per batch</span>
                            <span class="spec-value" id="spec-blocks">19</span>
                        </div>
                        <div class="spec-row">
                            <span class="spec-label">Chamber</span>
                            <span class="spec-value" id="spec-chamber">2' × 2' × 4'</span>
                        </div>
                        <div class="spec-row">
                            <span class="spec-label">Capacity</span>
                            <span class="spec-value" id="spec-capacity">24 blocks (79% full)</span>
                        </div>
                        <div class="spec-row">
                            <span class="spec-label">Shelving</span>
                            <span class="spec-value" id="spec-shelving">1× rack, 4 levels</span>
                        </div>
                        <div class="spec-row">
                            <span class="spec-label">FAE</span>
                            <span class="spec-value" id="spec-fae">5 exch/hr = 1.3 CFM</span>
                        </div>
                        <div class="spec-row">
                            <span class="spec-label">Humidity</span>
                            <span class="spec-value">85% RH (Inkbird IHC-200)</span>
                        </div>
                        <div class="spec-row">
                            <span class="spec-label">Fogger</span>
                            <span class="spec-value" id="spec-fogger">House of Hydro 1-disc</span>
                        </div>
                        <div class="spec-row">
                            <span class="spec-label">Duty Cycle</span>
                            <span class="spec-value" id="spec-duty">~7%</span>
                        </div>
                        <div class="spec-row">
                            <span class="spec-label">Disc Life</span>
                            <span class="spec-value" id="spec-life">4-6 years</span>
                        </div>
                        <div class="spec-row">
                            <span class="spec-label">Temperature</span>
                            <span class="spec-value">18-21°C</span>
                        </div>
                    </div>
                </div>

                <div class="tip-box" id="tip-box">
                    <div class="tip-title">Batch Cycle</div>
                    <p id="tip-text">3 weeks production, 1 week cleaning/restart. Full clean between batches reduces contamination risk.</p>
                </div>

                <button class="copy-btn" onclick="copySpecs()">Copy Spec Sheet</button>
            </div>
        </div>

        <footer>
            Calculator by <a href="https://heartwoodmushrooms.ca" target="_blank">Heartwood Mushrooms</a>
        </footer>
    </div>

    <script>
        // ============================================================
        // PHYSICAL DIMENSIONS (all in inches for calculations)
        // ============================================================

        // Block dimensions (width × depth × height when standing)
        // Based on standard unicorn filter patch bags
        const BLOCK_DIMS = {
            5: { w: 6, d: 5, h: 10, weight_kg: 2.3, weight_lb: 5, label: '5 lb (2.3 kg)' },
            10: { w: 8, d: 6, h: 12, weight_kg: 4.5, weight_lb: 10, label: '10 lb (4.5 kg)' }
        };

        // Spacing between blocks for airflow (inches)
        const BLOCK_SPACING = 3;

        // Wire rack shelving specs (standard metro/chrome shelving)
        const SHELF_DEPTH = 18;      // inches (standard wire shelf depth)
        const SHELF_SPACING = 18;    // inches between levels (block height + mushroom growth room)
        const SHELF_BOTTOM = 6;      // inches off floor for first shelf

        // Walkway width for larger tents (inches)
        const WALKWAY_WIDTH = 30;

        // ============================================================
        // TENT CONFIGURATIONS
        // ============================================================

        // Tent sizes with dimensions in feet
        // Capacity will be calculated based on actual shelf/block fitting
        const TENT_SIZES = [
            { dims: "2' × 2' × 4'", w: 2, d: 2, h: 4 },
            { dims: "2' × 2' × 5'", w: 2, d: 2, h: 5 },
            { dims: "2' × 4' × 5'", w: 2, d: 4, h: 5 },
            { dims: "4' × 2' × 6'", w: 4, d: 2, h: 6 },
            { dims: "3' × 3' × 6'", w: 3, d: 3, h: 6 },
            { dims: "4' × 4' × 6.5'", w: 4, d: 4, h: 6.5 },
            { dims: "4' × 4' × 7'", w: 4, d: 4, h: 7 },
            { dims: "5' × 5' × 7'", w: 5, d: 5, h: 7 },
            { dims: "8' × 4' × 7'", w: 8, d: 4, h: 7 },
            { dims: "8' × 8' × 7'", w: 8, d: 8, h: 7 },
            { dims: "10' × 10' × 8'", w: 10, d: 10, h: 8 }
        ];

        // ============================================================
        // OTHER CONSTANTS
        // ============================================================

        const DRY_MASS_RATIO = 0.4;
        const PRODUCTION_WEEKS = 3;
        const CYCLE_WEEKS = 4;
        const AIR_EXCHANGES_PER_HOUR = 5;
        const MOISTURE_CONTENT_85RH = 14.5;  // g/m³ at 20°C, 85% RH
        const DISC_LIFE_HOURS_MIN = 2500;
        const DISC_LIFE_HOURS_MAX = 3500;

        const FOGGERS = [
            { name: "1-disc", fullName: "House of Hydro 1-disc", output: 500 },
            { name: "3-disc", fullName: "House of Hydro 3-disc", output: 1500 },
            { name: "5-disc", fullName: "House of Hydro 5-disc", output: 1900 },
            { name: "12-disc", fullName: "House of Hydro 12-disc", output: 6000 }
        ];

        // ============================================================
        // STATE
        // ============================================================

        let currentYield = 3;
        let currentBlockSize = 5;
        let currentBE = 70;
        let currentCalcData = null;

        // ============================================================
        // CAPACITY CALCULATION - The core logic
        // ============================================================

        function calculateTentCapacity(tent, blockSize) {
            const block = BLOCK_DIMS[blockSize];
            const tentW = tent.w * 12;  // Convert feet to inches
            const tentD = tent.d * 12;
            const tentH = tent.h * 12;

            // Block footprint with spacing
            const blockFootprintW = block.w + BLOCK_SPACING;
            const blockFootprintD = block.d + BLOCK_SPACING;

            // Number of shelf levels that fit
            const usableHeight = tentH - SHELF_BOTTOM;
            const numLevels = Math.floor(usableHeight / SHELF_SPACING);

            // Determine shelving layout based on tent size
            let shelvingConfig = [];
            const needsWalkway = tentW > 48 || tentD > 48;

            if (tentW <= 36 && tentD <= 36) {
                // Small tent: single rack against back wall
                // Rack width = tent width - 2" clearance each side
                const rackW = tentW - 4;
                const rackD = Math.min(SHELF_DEPTH, tentD - 4);
                shelvingConfig.push({ w: rackW, d: rackD, x: 0, z: -(tentD/2) + rackD/2 + 2 });
            } else if (!needsWalkway) {
                // Medium tent: shelving on back wall, maybe sides
                const rackW = tentW - 4;
                const rackD = Math.min(SHELF_DEPTH, tentD - 4);
                shelvingConfig.push({ w: rackW, d: rackD, x: 0, z: -(tentD/2) + rackD/2 + 2 });

                // Add side shelves if tent is deep enough
                if (tentD > 36) {
                    const sideRackD = tentD - SHELF_DEPTH - 8;
                    shelvingConfig.push({ w: SHELF_DEPTH, d: sideRackD, x: -(tentW/2) + SHELF_DEPTH/2 + 2, z: SHELF_DEPTH/2 });
                    shelvingConfig.push({ w: SHELF_DEPTH, d: sideRackD, x: (tentW/2) - SHELF_DEPTH/2 - 2, z: SHELF_DEPTH/2 });
                }
            } else {
                // Large tent: perimeter shelving with walkway
                // Back wall rack
                const backRackW = tentW - 4;
                shelvingConfig.push({ w: backRackW, d: SHELF_DEPTH, x: 0, z: -(tentD/2) + SHELF_DEPTH/2 + 2 });

                // Side racks (leaving space for walkway at front)
                const sideRackD = tentD - SHELF_DEPTH - WALKWAY_WIDTH - 4;
                if (sideRackD > 12) {
                    shelvingConfig.push({ w: SHELF_DEPTH, d: sideRackD, x: -(tentW/2) + SHELF_DEPTH/2 + 2, z: -(WALKWAY_WIDTH/2) });
                    shelvingConfig.push({ w: SHELF_DEPTH, d: sideRackD, x: (tentW/2) - SHELF_DEPTH/2 - 2, z: -(WALKWAY_WIDTH/2) });
                }
            }

            // Calculate blocks per shelf configuration
            let totalCapacity = 0;
            let shelvesWithCapacity = [];

            shelvingConfig.forEach(shelf => {
                // Blocks that fit on this shelf's footprint
                const blocksWide = Math.floor(shelf.w / blockFootprintW);
                const blocksDeep = Math.floor(shelf.d / blockFootprintD);
                const blocksPerLevel = blocksWide * blocksDeep;
                const shelfCapacity = blocksPerLevel * numLevels;
                totalCapacity += shelfCapacity;

                shelvesWithCapacity.push({
                    ...shelf,
                    blocksWide,
                    blocksDeep,
                    blocksPerLevel,
                    numLevels
                });
            });

            return {
                capacity: totalCapacity,
                shelves: shelvesWithCapacity,
                numLevels,
                needsWalkway,
                tentW,
                tentD,
                tentH
            };
        }

        function findBestTent(blocksNeeded, blockSize) {
            for (const tent of TENT_SIZES) {
                const config = calculateTentCapacity(tent, blockSize);
                if (config.capacity >= blocksNeeded) {
                    return { tent, config };
                }
            }
            // Return largest if nothing fits
            const lastTent = TENT_SIZES[TENT_SIZES.length - 1];
            return { tent: lastTent, config: calculateTentCapacity(lastTent, blockSize) };
        }

        // ============================================================
        // THREE.JS VISUALIZATION
        // ============================================================

        let scene, camera, renderer, tentGroup;
        let isDragging = false;
        let previousMousePosition = { x: 0, y: 0 };

        function initThreeJS() {
            const container = document.getElementById('viz-container');
            const width = container.clientWidth;
            const height = container.clientHeight;

            scene = new THREE.Scene();
            camera = new THREE.PerspectiveCamera(45, width / height, 0.1, 1000);
            camera.position.set(6, 5, 8);
            camera.lookAt(0, 0, 0);

            renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
            renderer.setSize(width, height);
            renderer.setPixelRatio(window.devicePixelRatio);
            container.appendChild(renderer.domElement);

            const ambientLight = new THREE.AmbientLight(0xffffff, 0.6);
            scene.add(ambientLight);

            const directionalLight = new THREE.DirectionalLight(0xffffff, 0.8);
            directionalLight.position.set(5, 10, 7);
            scene.add(directionalLight);

            tentGroup = new THREE.Group();
            scene.add(tentGroup);

            container.addEventListener('mousedown', onMouseDown);
            container.addEventListener('mousemove', onMouseMove);
            container.addEventListener('mouseup', onMouseUp);
            container.addEventListener('mouseleave', onMouseUp);
            container.addEventListener('touchstart', onTouchStart, { passive: false });
            container.addEventListener('touchmove', onTouchMove, { passive: false });
            container.addEventListener('touchend', onMouseUp);

            window.addEventListener('resize', onWindowResize);
            animate();
        }

        function onWindowResize() {
            const container = document.getElementById('viz-container');
            camera.aspect = container.clientWidth / container.clientHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(container.clientWidth, container.clientHeight);
        }

        function onMouseDown(e) { isDragging = true; previousMousePosition = { x: e.clientX, y: e.clientY }; }
        function onMouseMove(e) {
            if (!isDragging) return;
            tentGroup.rotation.y += (e.clientX - previousMousePosition.x) * 0.01;
            tentGroup.rotation.x = Math.max(-0.5, Math.min(0.5, tentGroup.rotation.x + (e.clientY - previousMousePosition.y) * 0.005));
            previousMousePosition = { x: e.clientX, y: e.clientY };
        }
        function onMouseUp() { isDragging = false; }
        function onTouchStart(e) { if (e.touches.length === 1) { e.preventDefault(); isDragging = true; previousMousePosition = { x: e.touches[0].clientX, y: e.touches[0].clientY }; } }
        function onTouchMove(e) {
            if (!isDragging || e.touches.length !== 1) return;
            e.preventDefault();
            tentGroup.rotation.y += (e.touches[0].clientX - previousMousePosition.x) * 0.01;
            tentGroup.rotation.x = Math.max(-0.5, Math.min(0.5, tentGroup.rotation.x + (e.touches[0].clientY - previousMousePosition.y) * 0.005));
            previousMousePosition = { x: e.touches[0].clientX, y: e.touches[0].clientY };
        }

        function animate() { requestAnimationFrame(animate); renderer.render(scene, camera); }

        function createTextSprite(text, position, size = 0.15) {
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            canvas.width = 256;
            canvas.height = 64;
            ctx.fillStyle = '#d9bf90';
            ctx.font = 'bold 32px Arial';
            ctx.textAlign = 'center';
            ctx.fillText(text, 128, 40);

            const texture = new THREE.CanvasTexture(canvas);
            const material = new THREE.SpriteMaterial({ map: texture });
            const sprite = new THREE.Sprite(material);
            sprite.position.copy(position);
            sprite.scale.set(size * 4, size, 1);
            return sprite;
        }

        function update3DViz(data) {
            if (!tentGroup) return;

            while (tentGroup.children.length > 0) {
                tentGroup.remove(tentGroup.children[0]);
            }

            const { tent, config, blocksNeeded } = data;
            const block = BLOCK_DIMS[currentBlockSize];

            // Scale: 1 unit = 1 foot for the visualization
            const w = tent.w;
            const d = tent.d;
            const h = tent.h;

            // Tent wireframe
            const tentGeom = new THREE.BoxGeometry(w, h, d);
            const tentEdges = new THREE.EdgesGeometry(tentGeom);
            const tentLine = new THREE.LineSegments(tentEdges, new THREE.LineBasicMaterial({ color: 0xd9bf90, linewidth: 2 }));
            tentLine.position.y = h / 2;
            tentGroup.add(tentLine);

            // Semi-transparent walls
            const wallMat = new THREE.MeshBasicMaterial({ color: 0xd9bf90, transparent: true, opacity: 0.08, side: THREE.DoubleSide });
            const walls = new THREE.Mesh(tentGeom, wallMat);
            walls.position.y = h / 2;
            tentGroup.add(walls);

            // Dimension labels
            tentGroup.add(createTextSprite(`${tent.w}'`, new THREE.Vector3(0, -0.3, d/2 + 0.3)));
            tentGroup.add(createTextSprite(`${tent.d}'`, new THREE.Vector3(w/2 + 0.3, -0.3, 0)));
            tentGroup.add(createTextSprite(`${tent.h}'`, new THREE.Vector3(w/2 + 0.3, h/2, -d/2 - 0.2)));

            // Block dimensions in feet
            const blockW = block.w / 12;
            const blockD = block.d / 12;
            const blockH = block.h / 12;
            const spacing = BLOCK_SPACING / 12;
            const shelfDepthFt = SHELF_DEPTH / 12;
            const shelfSpacingFt = SHELF_SPACING / 12;
            const shelfBottomFt = SHELF_BOTTOM / 12;

            // Shelving and blocks
            const shelfMat = new THREE.MeshBasicMaterial({ color: 0x888888, transparent: true, opacity: 0.5 });
            const blockMat = new THREE.MeshLambertMaterial({ color: 0xf5f5f5 });

            let blocksPlaced = 0;

            config.shelves.forEach(shelf => {
                const shelfW = shelf.w / 12;
                const shelfD = shelf.d / 12;
                const shelfX = shelf.x / 12;
                const shelfZ = shelf.z / 12;

                for (let level = 0; level < config.numLevels; level++) {
                    const shelfY = shelfBottomFt + level * shelfSpacingFt;

                    // Draw shelf (thin box)
                    const shelfGeom = new THREE.BoxGeometry(shelfW, 0.02, shelfD);
                    const shelfMesh = new THREE.Mesh(shelfGeom, shelfMat);
                    shelfMesh.position.set(shelfX, shelfY, shelfZ);
                    tentGroup.add(shelfMesh);

                    // Draw shelf supports (4 legs)
                    if (level === 0) {
                        const legMat = new THREE.MeshBasicMaterial({ color: 0x666666 });
                        const legGeom = new THREE.CylinderGeometry(0.02, 0.02, shelfBottomFt);
                        [[1,1], [1,-1], [-1,1], [-1,-1]].forEach(([sx, sz]) => {
                            const leg = new THREE.Mesh(legGeom, legMat);
                            leg.position.set(shelfX + sx * (shelfW/2 - 0.05), shelfBottomFt/2, shelfZ + sz * (shelfD/2 - 0.05));
                            tentGroup.add(leg);
                        });
                    }

                    // Place blocks on this shelf
                    for (let row = 0; row < shelf.blocksDeep && blocksPlaced < blocksNeeded; row++) {
                        for (let col = 0; col < shelf.blocksWide && blocksPlaced < blocksNeeded; col++) {
                            const blockGeom = new THREE.BoxGeometry(blockW, blockH, blockD);
                            const blockMesh = new THREE.Mesh(blockGeom, blockMat);

                            const bx = shelfX - shelfW/2 + (blockW + spacing)/2 + col * (blockW + spacing);
                            const bz = shelfZ - shelfD/2 + (blockD + spacing)/2 + row * (blockD + spacing);
                            const by = shelfY + blockH/2 + 0.02;

                            blockMesh.position.set(bx, by, bz);
                            tentGroup.add(blockMesh);
                            blocksPlaced++;
                        }
                    }
                }
            });

            // Floor grid
            const gridHelper = new THREE.GridHelper(Math.max(w, d), Math.max(w, d) * 2, 0x444444, 0x333333);
            gridHelper.position.y = 0.001;
            tentGroup.add(gridHelper);

            // Adjust camera
            const maxDim = Math.max(w, d, h);
            camera.position.set(maxDim * 1.3, maxDim * 1.0, maxDim * 1.5);
            camera.lookAt(0, h * 0.35, 0);

            // Update stats
            const utilizationPct = Math.round((blocksNeeded / config.capacity) * 100);
            document.getElementById('viz-stats').textContent =
                `${blocksPlaced}/${config.capacity} blocks · ${utilizationPct}% utilized`;
        }

        // ============================================================
        // MAIN CALCULATION
        // ============================================================

        function calculate() {
            const block = BLOCK_DIMS[currentBlockSize];
            const beDecimal = currentBE / 100;

            const yieldPerBlock = block.weight_kg * DRY_MASS_RATIO * beDecimal;
            const totalCycleYield = currentYield * CYCLE_WEEKS;
            const blocksNeeded = yieldPerBlock > 0 ? Math.ceil(totalCycleYield / yieldPerBlock) : 0;
            const prodWeekYield = blocksNeeded > 0 ? (blocksNeeded * yieldPerBlock) / PRODUCTION_WEEKS : 0;

            // Find best tent based on actual capacity
            const { tent, config } = findBestTent(blocksNeeded, currentBlockSize);

            // FAE calculation
            const ft3 = tent.w * tent.d * tent.h;
            const m3 = ft3 * 0.0283168;
            const faePerHour = ft3 * AIR_EXCHANGES_PER_HOUR;
            const cfm = faePerHour / 60;

            // Moisture/fogger
            const exhaustM3PerHour = faePerHour * 0.0283168;
            const moistureLossGPerHour = exhaustM3PerHour * MOISTURE_CONTENT_85RH;
            const fogger = FOGGERS.find(f => (moistureLossGPerHour / f.output) * 100 <= 50) || FOGGERS[FOGGERS.length - 1];
            const dutyCycle = Math.min(100, (moistureLossGPerHour / fogger.output) * 100);
            const runHoursPerDay = (dutyCycle / 100) * 24;

            const discLifeMonthsMin = Math.round((DISC_LIFE_HOURS_MIN / runHoursPerDay) / 30);
            const discLifeMonthsMax = Math.round((DISC_LIFE_HOURS_MAX / runHoursPerDay) / 30);

            let fanRec = "80mm PC fan on low";
            if (cfm > 5) fanRec = "80mm PC fan on medium";
            if (cfm > 15) fanRec = "120mm fan or inline fan";
            if (cfm > 50) fanRec = '4" inline fan';
            if (cfm > 150) fanRec = '6" inline fan';

            const calcData = {
                block, yieldPerBlock, blocksNeeded, prodWeekYield,
                tent, config, ft3, m3, cfm, faePerHour,
                fogger, dutyCycle, discLifeMonthsMin, discLifeMonthsMax, fanRec,
                runHoursPerDay
            };

            currentCalcData = calcData;
            updateDisplay(calcData);
            update3DViz(calcData);
        }

        function updateDisplay(data) {
            const { block, yieldPerBlock, blocksNeeded, prodWeekYield, tent, config, ft3, m3, cfm, fogger, dutyCycle, discLifeMonthsMin, discLifeMonthsMax, fanRec, runHoursPerDay } = data;

            document.getElementById('target-display').textContent = `${currentYield} kg/week avg`;
            document.getElementById('cycle-info').textContent = `~${prodWeekYield.toFixed(1)} kg weeks 1-3, week 4 cleaning`;

            document.getElementById('blocks-value').textContent = blocksNeeded;
            document.getElementById('blocks-detail').textContent = `capacity: ${config.capacity}`;

            document.getElementById('chamber-value').textContent = `${ft3} ft³`;
            document.getElementById('chamber-detail').textContent = tent.dims;

            document.getElementById('fae-value').textContent = `${cfm.toFixed(1)} CFM`;
            document.getElementById('fae-detail').textContent = fanRec;

            document.getElementById('fogger-value').textContent = fogger.name;
            document.getElementById('fogger-detail').textContent = `~${Math.round(dutyCycle)}% duty cycle`;

            document.getElementById('spec-target').textContent = `${currentYield} kg/week`;
            document.getElementById('spec-prod-weeks').textContent = `~${prodWeekYield.toFixed(1)} kg/wk for 3 weeks`;
            document.getElementById('spec-block-size').textContent = `${block.label} (${block.w}"×${block.d}"×${block.h}")`;
            document.getElementById('spec-be').textContent = `${currentBE}%`;
            document.getElementById('spec-yield-block').textContent = `${yieldPerBlock.toFixed(2)} kg`;
            document.getElementById('spec-blocks').textContent = blocksNeeded;
            document.getElementById('spec-chamber').textContent = `${tent.dims} (${ft3} ft³)`;

            const utilizationPct = Math.round((blocksNeeded / config.capacity) * 100);
            document.getElementById('spec-capacity').textContent = `${config.capacity} blocks (${utilizationPct}% used)`;

            const numRacks = config.shelves.length;
            document.getElementById('spec-shelving').textContent = `${numRacks}× rack${numRacks > 1 ? 's' : ''}, ${config.numLevels} levels`;

            document.getElementById('spec-fae').textContent = `5 exch/hr = ${cfm.toFixed(1)} CFM`;
            document.getElementById('spec-fogger').textContent = `${fogger.fullName}`;
            document.getElementById('spec-duty').textContent = `~${Math.round(dutyCycle)}% (${runHoursPerDay.toFixed(1)} hrs/day)`;

            let discLifeText = discLifeMonthsMin >= 24
                ? `${Math.round(discLifeMonthsMin/12)}-${Math.round(discLifeMonthsMax/12)} years`
                : `${discLifeMonthsMin}-${discLifeMonthsMax} months`;
            document.getElementById('spec-life').textContent = discLifeText;

            // Tips
            const tipText = document.getElementById('tip-text');
            if (currentBE === 0) {
                tipText.textContent = "Set biological efficiency above 0% to calculate block requirements.";
            } else if (yieldPerBlock < 0.1) {
                tipText.textContent = "Very low BE results in minimal yield per block.";
            } else if (utilizationPct > 90) {
                tipText.textContent = "Tent is nearly full. Good efficiency, but leave room for airflow.";
            } else if (utilizationPct < 50 && blocksNeeded > 10) {
                tipText.textContent = "Tent has extra capacity. Consider a smaller tent or plan for growth.";
            } else if (config.needsWalkway) {
                tipText.textContent = "Perimeter shelving layout with center walkway for access and harvesting.";
            } else {
                tipText.textContent = "3 weeks production, 1 week cleaning/restart. Full clean between batches reduces contamination risk.";
            }
        }

        function copySpecs() {
            const specs = [];
            document.querySelectorAll('.spec-row').forEach(row => {
                const label = row.querySelector('.spec-label').textContent;
                const value = row.querySelector('.spec-value').textContent;
                specs.push(`${label}: ${value}`);
            });

            const text = `FRUITING CHAMBER SPECS (BATCH MODE)\n${'='.repeat(40)}\n${specs.join('\n')}\n\nCalculated at growcalc.heartwoodmushrooms.ca`;

            navigator.clipboard.writeText(text).then(() => {
                const btn = document.querySelector('.copy-btn');
                btn.textContent = 'Copied!';
                setTimeout(() => btn.textContent = 'Copy Spec Sheet', 2000);
            });
        }

        // ============================================================
        // INIT
        // ============================================================

        const yieldSlider = document.getElementById('yield-slider');
        const yieldValue = document.getElementById('yield-value');
        const beSlider = document.getElementById('be-slider');
        const beValue = document.getElementById('be-value');
        const sizeBtns = document.querySelectorAll('.size-btn');

        yieldSlider.addEventListener('input', (e) => {
            currentYield = parseFloat(e.target.value);
            yieldValue.textContent = currentYield;
            calculate();
        });

        beSlider.addEventListener('input', (e) => {
            currentBE = parseInt(e.target.value);
            beValue.textContent = currentBE;
            calculate();
        });

        sizeBtns.forEach(btn => {
            btn.addEventListener('click', () => {
                sizeBtns.forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                currentBlockSize = parseInt(btn.dataset.size);
                calculate();
            });
        });

        initThreeJS();
        calculate();
    </script>
</body>
</html>
